<%*
// 快捷键触发：Control+Shift+K
// 作者：考现学观察者
// 版本：1.0

// 1. 获取文件名并生成带日期的完整文件名
const fileName = await tp.system.prompt("请输入文件名：");
if (!fileName) {
  new Notice("文件名不能为空！");
  throw new Error("文件名不能为空");
}

// 生成日期前缀
const today = new Date();
const datePrefix = tp.date.now("YYYY-MM-DD");
const fullFileName = `${datePrefix} ${fileName}.md`;

// 等待用户确认创建文件
await tp.file.rename(fullFileName);

// 2. 收集天气信息
const weather = await tp.system.prompt("今天天气如何？", "晴朗");

// 3. 收集标签（支持顿号分隔）
const tagsInput = await tp.system.prompt("请输入标签（用顿号分隔）：", "考现学");
const tags = tagsInput.split("、").map(tag => tag.trim()).filter(tag => tag);

// 4. 收集灵光闪现（可选）
const flash = await tp.system.prompt("今日灵光闪现（直接回车跳过）：", "");
const hasFlash = flash && flash.trim() !== "";

// 5. 收集考现笔记（多行输入）
const observations = [];
let observationIndex = 1;

new Notice("开始记录考现笔记（直接回车结束）");

while (true) {
  const observation = await tp.system.prompt(`考现笔记 ${observationIndex}（直接回车结束）：`);
  if (!observation || observation.trim() === "") {
    break;
  }
  observations.push(observation);
  observationIndex++;
}

// 6. 收集调查者信息
const observer = await tp.system.prompt("调查者姓名：", "观察者");

// 7. 生成详细时间信息
const now = new Date();
const fullDateTime = tp.date.now("YYYY年MM月DD日 HH:mm:ss");
const weekDay = now.toLocaleDateString('zh-CN', { weekday: 'long' });

// 计算周数（ISO周）
const getWeekNumber = (date) => {
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
};
const weekNumber = getWeekNumber(now);

// 计算今年的第几天
const startOfYear = new Date(now.getFullYear(), 0, 0);
const diff = now - startOfYear;
const dayOfYear = Math.floor(diff / (1000 * 60 * 60 * 24));

// 生成标签列表
const tagList = tags.map(tag => `"${tag}"`).join(", ");

// 开始生成内容
tR += `---
title: "${fileName}"
date: "${datePrefix}"
weather: "${weather}"
tags: [${tagList}]
observer: "${observer}"
created_time: "${fullDateTime}"
week_day: "${weekDay}"
week_number: ${weekNumber}
day_of_year: ${dayOfYear}
observation_count: ${observations.length}
has_flash: ${hasFlash}
---

# ${fileName}

## 📅 观察信息

| 项目 | 内容 |
|------|------|
| **观察日期** | ${datePrefix} |
| **观察时间** | ${fullDateTime} |
| **星期** | ${weekDay} |
| **第几周** | 第${weekNumber}周 |
| **第几天** | 今年第${dayOfYear}天 |
| **天气** | ${weather} |
| **观察者** | ${observer} |
| **观察条数** | ${observations.length}条 |

`;

// 添加灵光闪现部分
if (hasFlash) {
  tR += `## 💡 今日灵光闪现

> ${flash}

`;
}

// 添加考现笔记部分
if (observations.length > 0) {
  tR += `## 👀 考现笔记记录

`;
  observations.forEach((obs, index) => {
    tR += `### ${index + 1}. ${obs}

`;
  });
} else {
  tR += `## 👀 考现笔记记录

> 本次观察暂无具体记录内容

`;
}

// 添加分析部分
tR += `## 🎯 观察分析

### 主要发现
${observations.length > 0 ? '通过本次观察，发现了以下值得注意的现象：' : '本次作为预备观察，为后续深入调研做铺垫。'}

### 后续计划
- [ ] 深入观察相关现象
- [ ] 记录更多细节信息
- [ ] 分析背后的原因和影响

---

## 📊 元数据

**创建时间**：${fullDateTime} (${weekDay})  
**时间坐标**：今年第${dayOfYear}天，第${weekNumber}周  
**观察者**：${observer}  
**天气状况**：${weather}  
**观察条数**：${observations.length}条  
**标签**：${tags.join("、")}

---

*📝 通过 Control+Shift+K 快捷键快速创建*  
*🎯 专为考现学观察设计的高效模板*  
*💡 持续记录，持续思考，持续改进*

---
> 📌 **考现学提醒**：每一次观察都是对生活的深度思考，保持好奇心和观察力是最重要的品质。`;
%>